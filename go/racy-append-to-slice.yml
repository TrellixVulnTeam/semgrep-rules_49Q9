rules:
- id: racy-append-to-slice
  languages:
    - go
  patterns:
    - pattern: |
          $SLICE = append($SLICE, $ITEM)
    - pattern-either:
      - pattern-inside: |
          var $SLICE []$TYPE
          ...
          for ... {
            ...
            go func(...) {
              ...
            }(...)
            ...
          }
      - pattern-inside: |
          var $SLICE []*$TYPE
          ...
          for ... {
            ...
            go func(...) {
              ...
            }(...)
            ...
          }
      - pattern-inside: |
          var $SLICE []*$TYPE
          ...
          go func(...) {
            for ... {
              ...
            }
            ...
          }(...)
      - pattern-inside: |
          $SLICE := make([]$TYPE, ...)
          ...
          for ... {
            ...
            go func(...) {
              ...
            }(...)
            ...
          }
      - pattern-inside: |
          $SLICE := make([]*$TYPE, ...)
          ...
          for ... {
            ...
            go func(...) {
              ...
            }(...)
            ...
          }
      - pattern-inside: |
          $SLICE := make([]*$TYPE, ...)
          ...
          go func(...) {
            for ... {
              ...
            }
            ...
          }(...)
  message: |
    Appending $SLICE from multiple goroutines is not concurrency safe.
  severity: ERROR
